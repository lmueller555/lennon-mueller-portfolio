<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lennon Mueller Portfolio</title>
    <style>
        html, body { height: 100%; margin: 0; }
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('Mueller Logo.png') no-repeat center center;
            background-size: cover; opacity: 0.5; z-index: -1;
        }
        h1.title { color: white; text-align: center; text-decoration: underline; font-size: 48px; }
        nav { text-align: center; margin-top: 10px; background: rgba(0,0,0,0.6); padding: 10px 0; }
        nav a { margin: 0 15px; color: white; text-decoration: none; border: 1px solid white; padding: 8px 15px; border-radius: 4px; background: rgba(0,0,0,0.6); }
        #appContainer { background: rgba(0,0,0,0.6); color: white; padding: 20px; margin: 20px auto; width: 90%; max-width: 1100px; border-radius: 8px; }
        h2.sim-title { text-align: center; margin-top: 0; }
        .metric-row { display: flex; flex-wrap: wrap; justify-content: space-around; }
        .metric { text-align: center; margin: 10px; }
        #chart, #openChart { display: block; margin: 20px auto; border: 1px solid #ddd; }
        #openContainer table { width: 100%; border-collapse: collapse; }
        #openContainer th, #openContainer td { padding: 4px; border-bottom: 1px solid #ddd; }
        .pos { color: green; }
        .neg { color: red; }
    </style>
</head>
<body>
<h1 class="title">Lennon Mueller</h1>
<nav>
    <a href="index.html">Home</a>
    <a href="app-development.html">App Development</a>
    <a href="ai-ml.html">AI/ML</a>
</nav>
<div id="appContainer">
    <h2 class="sim-title">Investing Dashboard</h2>
    <div class="metric-row">
        <div class="metric"><div id="finalValue">$0</div><div>Final Portfolio Value</div></div>
        <div class="metric"><div id="roi">0%</div><div>ROI</div></div>
        <div class="metric"><div id="winRate">0%</div><div>Win Rate</div></div>
        <div class="metric">
            <label for="changePeriod">Change Period</label>
            <select id="changePeriod">
                <option value="7">Weekly</option>
                <option value="30">Monthly</option>
                <option value="365">Yearly</option>
            </select>
            <div><span id="changeValue">$0</span> (<span id="changePct">0%</span>)</div>
        </div>
    </div>
    <div style="text-align:center;margin-top:10px;">
        <label for="companySelect">Select Company</label>
        <select id="companySelect"></select>
    </div>
    <canvas id="chart" width="800" height="400"></canvas>
    <h3 style="text-align:center;">Open Positions</h3>
    <div id="openContainer" style="overflow-x:auto;"></div>
    <canvas id="openChart" width="600" height="400"></canvas>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const FILE_PATH = 'Updated_Dataset_with_Signals_Ranked.csv';
    const INITIAL_INVEST = 50000;
    const CONTRIB_AMOUNT = 3000;
    const CONTRIB_FREQ = 22;
    const HOLD_DAYS = 25;
    const MANUAL_EXIT_DATE = '6/27/2024';
    const RESUME_DATE = '6/20/2025';
    const CALC_RESET_DATE = '6/20/2025';

    let dataset = [];
    let dateIndex = [];
    let equityCurve = [];
    let openPositions = [];
    let tradeHistory = [];
    let finalVal = 0;
    let roi = 0;
    let winRate = 0;

    fetch(FILE_PATH)
        .then(r => r.text())
        .then(text => { parseDataset(text); runBacktest(); populateUI(); });

    function parseDataset(text){
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',');
        const dIdx = headers.indexOf('Date');
        const pIdx = headers.indexOf('Price') >= 0 ? headers.indexOf('Price') : headers.indexOf('Close/Last');
        const oIdx = headers.indexOf('Open');
        const cIdx = headers.indexOf('Company');
        const bIdx = headers.indexOf('30 Day Buy Signal');
        for(let i=1;i<lines.length;i++){
            const cols = lines[i].split(',');
            dataset.push({
                date: cols[dIdx],
                price: parseFloat(cols[pIdx]),
                open: parseFloat(cols[oIdx]),
                company: cols[cIdx],
                buy: parseInt(cols[bIdx]) || 0
            });
        }
        dataset.sort((a,b)=> new Date(a.date)-new Date(b.date));
        dateIndex = [...new Set(dataset.map(r=>r.date))];
    }

    function runBacktest(){
        let cash = INITIAL_INVEST;
        let contribCtr = 0;
        const portfolio = [];
        const trades = [];
        let tradingActive = true;
        equityCurve = [];
        tradeHistory = [];

        for(let i=0;i<dateIndex.length;i++){
            const currDate = dateIndex[i];
            contribCtr++;
            if(contribCtr===CONTRIB_FREQ){ cash += CONTRIB_AMOUNT; contribCtr=0; }

            if(new Date(currDate).getTime() === new Date(MANUAL_EXIT_DATE).getTime()){
                for(const pos of [...portfolio]){
                    const row = dataset.find(r => r.company===pos.company && r.date===currDate);
                    if(!row) continue;
                    const px = row.price;
                    const profit = (px-pos.buy_price)*pos.shares;
                    cash += pos.shares*px;
                    trades.push(profit>0);
                    tradeHistory.push({company:pos.company,date:currDate,action:'sell',price:px});
                }
                portfolio.length = 0;
                tradingActive = false;
            }

            if(new Date(currDate).getTime() >= new Date(RESUME_DATE).getTime()){
                tradingActive = true;
            }

            const dailyRows = dataset.filter(r=>r.date===currDate);
            for(const row of dailyRows){
                if(tradingActive && row.buy===1 && cash>0 && i+1<dateIndex.length){
                    const nxt = dataset.find(r=>r.company===row.company && r.date===dateIndex[i+1]);
                    if(!nxt) continue;
                    const qty = (cash*0.30)/nxt.open;
                    if(qty>=1){
                        const invest = qty*nxt.open;
                        cash -= invest;
                        const buyDate = dateIndex[i+1];
                        const sellDate = (i+HOLD_DAYS < dateIndex.length) ? dateIndex[i+HOLD_DAYS] : null;
                        portfolio.push({company:row.company,buy_date:buyDate,sell_date:sellDate,shares:qty,buy_price:nxt.open});
                        tradeHistory.push({company:row.company,date:buyDate,action:'buy',price:nxt.open});
                    }
                }
            }

            for(let j=portfolio.length-1;j>=0;j--){
                const pos = portfolio[j];
                if(pos.sell_date && currDate===pos.sell_date){
                    const row = dataset.find(r=>r.company===pos.company && r.date===pos.sell_date);
                    if(!row) continue;
                    const px = row.price;
                    const profit = (px-pos.buy_price)*pos.shares;
                    cash += pos.shares*px;
                    trades.push(profit>0);
                    tradeHistory.push({company:pos.company,date:currDate,action:'sell',price:px});
                    portfolio.splice(j,1);
                }
            }

            let pv = 0;
            for(const pos of portfolio){
                const r = dataset.find(x=>x.company===pos.company && x.date===currDate);
                if(r) pv += pos.shares*r.price;
            }
            equityCurve.push({date: currDate, value: cash + pv});
        }

        const totalContrib = INITIAL_INVEST + CONTRIB_AMOUNT * Math.floor(dateIndex.length/CONTRIB_FREQ);
        finalVal = equityCurve[equityCurve.length-1].value;
        roi = ((finalVal-totalContrib)/totalContrib)*100;
        winRate = trades.length ? (trades.filter(t=>t).length/trades.length)*100 : 0;

        const lastDate = dateIndex[dateIndex.length-1];
        openPositions = portfolio.map(pos => {
            const row = dataset.find(r=>r.company===pos.company && r.date===lastDate);
            if(!row) return null;
            let daysRemaining;
            if(pos.sell_date){
                daysRemaining = Math.floor((new Date(pos.sell_date) - new Date(lastDate))/(1000*60*60*24));
            } else {
                const held = Math.floor((new Date(lastDate)-new Date(pos.buy_date))/(1000*60*60*24));
                daysRemaining = HOLD_DAYS - held;
            }
            const plVal = (row.price-pos.buy_price)*pos.shares;
            const plPct = (row.price-pos.buy_price)/pos.buy_price*100;
            return {company:pos.company,shares:pos.shares,buy_date:pos.buy_date,buy_price:pos.buy_price,current_price:row.price,pl_val:plVal,pl_pct:plPct,days_remaining:daysRemaining};
        }).filter(Boolean);
    }

    function populateUI(){
        document.getElementById('finalValue').textContent = '$'+finalVal.toFixed(2);
        document.getElementById('roi').textContent = roi.toFixed(2)+'%';
        document.getElementById('winRate').textContent = winRate.toFixed(2)+'%';
        updateChangeMetric(parseInt(document.getElementById('changePeriod').value));
        populateCompanyOptions();
        drawMainChart();
        displayOpenPositions();
        drawOpenChart();
    }

    function updateChangeMetric(days){
        const resetIdx = equityCurve.findIndex(p=> new Date(p.date) >= new Date(CALC_RESET_DATE));
        const endIdx = equityCurve.length-1;
        let startIdx = endIdx - days;
        if(startIdx < resetIdx) startIdx = resetIdx;
        if(startIdx < 0) startIdx = 0;
        const startVal = equityCurve[startIdx].value;
        const change = equityCurve[endIdx].value - startVal;
        const pct = startVal ? (change/startVal)*100 : 0;
        document.getElementById('changeValue').textContent = '$'+change.toFixed(2);
        document.getElementById('changePct').textContent = pct.toFixed(2)+'%';
    }

    document.getElementById('changePeriod').addEventListener('change', function(){
        updateChangeMetric(parseInt(this.value));
    });

    function populateCompanyOptions(){
        const select = document.getElementById('companySelect');
        const counts = {};
        tradeHistory.filter(t=>t.action==='buy').forEach(t=>{ counts[t.company]=(counts[t.company]||0)+1; });
        select.innerHTML = '<option value="">All Companies</option>' +
            Object.keys(counts).map(c => `<option value="${c}">${c} (${counts[c]})</option>`).join('');
        select.addEventListener('change', drawMainChart);
    }

    function drawMainChart(){
        const canvas = document.getElementById('chart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        const selected = document.getElementById('companySelect').value;
        if(!selected){
            const vals = equityCurve.map(p=>p.value);
            const maxVal = Math.max(...vals); const minVal = Math.min(...vals);
            const padding = 40;
            const xScale = (canvas.width - padding*2) / (equityCurve.length-1);
            const yScale = (canvas.height - padding*2) / (maxVal - minVal || 1);
            ctx.strokeStyle = '#00BFFF';
            ctx.beginPath();
            for(let i=0;i<equityCurve.length;i++){
                const x = padding + i*xScale;
                const y = canvas.height - padding - (equityCurve[i].value - minVal)*yScale;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            // X-axis labels
            ctx.fillStyle = 'white';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Date', canvas.width/2, canvas.height - padding + 35);
            ctx.save();
            ctx.translate(padding - 30, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Portfolio Value ($)', 0, 0);
            ctx.restore();
            const step = Math.ceil(equityCurve.length/10);
            ctx.textAlign = 'right';
            for(let i=0;i<equityCurve.length;i+=step){
                const x = padding + i*xScale;
                const label = equityCurve[i].date;
                ctx.save();
                ctx.translate(x, canvas.height - padding + 20);
                ctx.rotate(-Math.PI/4);
                ctx.fillText(label,0,0);
                ctx.restore();
            }
            const midVal = minVal + (maxVal - minVal)/2;
            [minVal, midVal, maxVal].forEach(val => {
                const y = canvas.height - padding - (val - minVal)*yScale;
                ctx.fillText(val.toFixed(2), padding-5, y+3);
            });
        } else {
            const history = dataset.filter(r=>r.company===selected);
            history.sort((a,b)=> new Date(a.date)-new Date(b.date));
            const vals = history.map(h=>h.price);
            const maxVal = Math.max(...vals); const minVal = Math.min(...vals);
            const padding = 40;
            const xScale = (canvas.width - padding*2) / (history.length-1);
            const yScale = (canvas.height - padding*2) / (maxVal - minVal || 1);
            ctx.strokeStyle = '#00BFFF';
            ctx.beginPath();
            for(let i=0;i<history.length;i++){
                const x = padding + i*xScale;
                const y = canvas.height - padding - (history[i].price - minVal)*yScale;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            ctx.fillStyle = 'white';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Date', canvas.width/2, canvas.height - padding + 35);
            ctx.save();
            ctx.translate(padding - 30, canvas.height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Price ($)', 0, 0);
            ctx.restore();
            const step2 = Math.ceil(history.length/10);
            ctx.textAlign = 'right';
            for(let i=0;i<history.length;i+=step2){
                const x = padding + i*xScale;
                const label = history[i].date;
                ctx.save();
                ctx.translate(x, canvas.height - padding + 20);
                ctx.rotate(-Math.PI/4);
                ctx.fillText(label,0,0);
                ctx.restore();
            }
            const midVal = minVal + (maxVal - minVal)/2;
            [minVal, midVal, maxVal].forEach(val => {
                const y = canvas.height - padding - (val - minVal)*yScale;
                ctx.fillText(val.toFixed(2), padding-5, y+3);
            });
            const buys = tradeHistory.filter(t=>t.company===selected && t.action==='buy');
            const sells = tradeHistory.filter(t=>t.company===selected && t.action==='sell');
            ctx.fillStyle = 'green';
            buys.forEach(b => {
                const idx = history.findIndex(h=>h.date===b.date);
                if(idx>=0){
                    const x = padding + idx*xScale;
                    const y = canvas.height - padding - (history[idx].price - minVal)*yScale;
                    ctx.beginPath();
                    ctx.moveTo(x, y-5); ctx.lineTo(x-5,y+5); ctx.lineTo(x+5,y+5); ctx.fill();
                }
            });
            ctx.fillStyle = 'red';
            sells.forEach(s => {
                const idx = history.findIndex(h=>h.date===s.date);
                if(idx>=0){
                    const x = padding + idx*xScale;
                    const y = canvas.height - padding - (history[idx].price - minVal)*yScale;
                    ctx.beginPath();
                    ctx.moveTo(x, y+5); ctx.lineTo(x-5,y-5); ctx.lineTo(x+5,y-5); ctx.fill();
                }
            });
        }
    }

    function displayOpenPositions(){
        const container = document.getElementById('openContainer');
        if(openPositions.length===0){ container.innerHTML = '<p>No active trades.</p>'; return; }
        let html = '<table><thead><tr><th>Company</th><th>Shares</th><th>Buy Date</th><th>Buy Price</th><th>Current Price</th><th>P/L $</th><th>P/L %</th><th>Days Remaining</th></tr></thead><tbody>';
        for(const row of openPositions){
            const plClass = row.pl_val>0 ? 'pos' : (row.pl_val<0 ? 'neg' : '');
            html += `<tr><td>${row.company}</td><td>${row.shares.toFixed(2)}</td><td>${row.buy_date}</td><td>${row.buy_price.toFixed(2)}</td><td>${row.current_price.toFixed(2)}</td><td class="${plClass}">${row.pl_val.toFixed(2)}</td><td class="${plClass}">${row.pl_pct.toFixed(2)}</td><td>${row.days_remaining}</td></tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function drawOpenChart(){
        const canvas = document.getElementById('openChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(openPositions.length===0) return;
        const padding = 40;
        let maxVal = -Infinity, minVal = Infinity, allPoints = [];
        openPositions.forEach(pos=>{
            const startIdx = dataset.findIndex(r=>r.company===pos.company && r.date===pos.buy_date);
            const history = dataset.filter((r,idx)=>r.company===pos.company && idx>=startIdx);
            const pts = history.map(h=>({date:h.date, pct:(h.price-pos.buy_price)/pos.buy_price*100}));
            allPoints.push({company:pos.company, pts});
            pts.forEach(p=>{ if(p.pct>maxVal) maxVal=p.pct; if(p.pct<minVal) minVal=p.pct; });
        });
        const yScale = (canvas.height - padding*2) / (maxVal - minVal || 1);
        allPoints.forEach(obj=>{
            const pts = obj.pts;
            const xScale = (canvas.width - padding*2) / (pts.length-1 || 1);
            ctx.beginPath();
            const color = '#' + Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0');
            ctx.strokeStyle = color;
            for(let i=0;i<pts.length;i++){
                const x = padding + i*xScale;
                const y = canvas.height - padding - (pts[i].pct - minVal)*yScale;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            const step3 = Math.ceil(pts.length/10);
            ctx.fillStyle='white';
            ctx.font='12px sans-serif';
            ctx.textAlign='right';
            for(let i=0;i<pts.length;i+=step3){
                const x = padding + i*xScale;
                ctx.save();
                ctx.translate(x, canvas.height - padding + 20);
                ctx.rotate(-Math.PI/4);
                ctx.fillText(i.toString(),0,0);
                ctx.restore();
            }
        });
        ctx.fillStyle='white';
        ctx.font='12px sans-serif';
        ctx.textAlign='center';
        ctx.fillText('Days Since Buy', canvas.width/2, canvas.height - padding + 35);
        ctx.save();
        ctx.translate(padding - 30, canvas.height/2);
        ctx.rotate(-Math.PI/2);
        ctx.fillText('% Change',0,0);
        ctx.restore();
    }
});
</script>
</body>
</html>
